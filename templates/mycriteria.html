{%extends 'layout.html'%}

{% block body %}
  <div class="criteria-form" oninput="showSliderValues();">
    <h1 class="pageHeader">
    {% if session.logged_in %}
      {{session.name}}'s Criteria
    {% else %}
      Criteria
    {% endif %}
    </h1>
    <center><h2 class="criteriaTotalScore" id="total_score"></h2></center>
    <form action="" method="POST">
      <div class="criteria_container" >
        <div class="criteriaColumnLeft">
          {% for category in categoryList %}
            {% if loop.index < ((categoryList|length)/2)+1 %}
            <div class="criteriaGroup" id="criteria_group_{{category}}">
              <div class="criteriaLabel" id="criteria_label_{{category}}">{{category}}</div>
              <div class="criteriaScore" id="criteria_score_{{category}}"></div>
              <br />
              <input type="range" min="0" max="100" value="0" class="slider" id="criteria_{{category}}" name="criteria_{{category}}" oninput="maxCombinedValues('{{category}}');">
            </div>
            {% endif %}
          {% endfor %}
        </div>

        <div class="criteriaColumnRight">
          {% for category in categoryList %}
            {% if loop.index >= ((categoryList|length)/2)+1 %}
            <div class="criteriaGroup" id="criteria_group_{{category}}">
              <div class="criteriaLabel" id="criteria_label_{{category}}">{{category}}</div>
              <div class="criteriaScore" id="criteria_score_{{category}}"></div>
              <br />
              <input type="range" min="0" max="100" value="0" class="slider" id="criteria_{{category}}" name="criteria_{{category}}" oninput="maxCombinedValues('{{category}}');">
            </div>
            {% endif %}
          {% endfor %}
        </div>


        <br /><br />
        <center>
          <div class="criteriaButtonSet">
            <button type="submit" class="criteriaSaveButton btn btn-primary" id="criteria_save_button">Save Criteria</button>
            <button type="button" class="criteriaRestoreButton btn btn-primary" id="criteria_restore_button" onclick="restoreSliderValues();">Restore</button>
            <button type="reset" class="criterieaResetButton btn btn-primary" id="criteria_reset_button" onclick="return resetSliders();">Reset All</button>
          </div>
        </center>
      </div>
    </form>

    <br />
    <!-- Success and Error Messages -->
    <div id="successAlert" class="alert alert-success" role="alert" style="display:none;"></div>
	  <div id="errorAlert" class="alert alert-danger" role="alert" style="display:none;"></div>
    <br />
  </div>

  <script>
    window.onload = function loadCriteria(){
      // Store session variable
      var session = {{ session | tojson }}; // session variable
      var categoryList = {{ categoryList | tojson }}; // list of categories

      // For each rating, set the the corresponding slider value
      for(i=0; i < categoryList.length; i++){
        var slider_name = "criteria_"+categoryList[i];
        document.getElementById(slider_name).value = session[categoryList[i]];
      }

      showSliderValues();
    }

    function restoreSliderValues(){
      // Store session variable
      var session = {{ session | tojson }}; // session variable
      var categoryList = {{ categoryList | tojson }}; // list of categories

      // For each rating, set the the corresponding slider value
      for(i=0; i < categoryList.length; i++){
        var slider_name = "criteria_"+categoryList[i];
        document.getElementById(slider_name).value = session[categoryList[i]];
      }

      showSliderValues();
    }

    function showSliderValues(){
      // Individual sliders
      var categoryList = {{ categoryList | tojson }}; // list of categories
      for(i=0; i<categoryList.length;  i++){
        // First get reference to slider to get its vlaue
        var active_slider_name = "criteria_"+categoryList[i];
        var activeSliderValue = document.getElementById(active_slider_name).value;

        // Then update the score element for the corresponding category
        var scoreElementName = 'criteria_score_'+categoryList[i];
        document.getElementById(scoreElementName).innerHTML = activeSliderValue;
      }

      // Show total combined value
      var totalValue=0;
      for(i=0; i<categoryList.length;  i++){
        // First get reference to slider to get its vlaue
        var active_slider_name = "criteria_"+categoryList[i];
        var activeSliderValue = document.getElementById(active_slider_name).value;
        totalValue += Number(activeSliderValue);
      }

      document.getElementById('total_score').innerHTML='Total: '+totalValue + '/100';

    }

    function resetSliders(){
      setTimeout(function(){
          showSliderValues();
      }, 0);
      return true;
    }



    // Function to ensure that the combined max values of the sliders equal 100
    function maxCombinedValues(activeCategory){
      var categoryList = {{ categoryList | tojson }}; // list of categories
      var totalValue=0; // total value between all sliders
      var active_slider_name = "criteria_"+activeCategory;

      for(i=0; i < categoryList.length; i++){
        var slider_name = "criteria_"+categoryList[i];
        totalValue += Number(document.getElementById(slider_name).value);
      }
      if(totalValue > 100){
        // get combined values of other sliders
        var other_sliders_value = 0;
        for(i=0; i < categoryList.length; i++){
          var slider_name = "criteria_"+categoryList[i];
          if(slider_name != active_slider_name){
            other_sliders_value += Number(document.getElementById(slider_name).value);
          }
        }
        var newVal = 100 - other_sliders_value;
        document.getElementById(active_slider_name).value = newVal;

      }
    }
  </script>

{% endblock %}
